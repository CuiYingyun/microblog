{{/* Ê∑ªÂä†ÈÄèÊòéÁöÑfavicon‰ª•ÊõøÊç¢Á¥´Ëâ≤ÊñπÊ°Ü */}}
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='50' x='50' text-anchor='middle' dominant-baseline='central' font-size='80'>üë§</text></svg>">
<link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='50' x='50' text-anchor='middle' dominant-baseline='central' font-size='80'>üë§</text></svg>">

{{/* Load custom CSS */}}
{{ $customCSS := resources.Get "css/custom.css" | resources.Minify | resources.Fingerprint }}
<link rel="stylesheet" href="{{ $customCSS.RelPermalink }}" integrity="{{ $customCSS.Data.Integrity }}" />

{{/* Initialize dark mode immediately to prevent flash */}}
<script>
  // Apply dark mode immediately if saved in localStorage
  (function() {
    if (localStorage.getItem('appearance') === 'dark' || 
        (!localStorage.getItem('appearance') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
    }
  })();
</script>

{{/* Enhanced preloading strategy */}}
{{/* DNS prefetch for external resources */}}
<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="dns-prefetch" href="//fonts.gstatic.com">

{{/* Preconnect to speed up font loading */}}
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

{{/* Prefetch navigation pages */}}
<link rel="prefetch" href="/microblog/posts/">
<link rel="prefetch" href="/microblog/tags/">
<link rel="prefetch" href="/microblog/about/">

{{/* Prerender the most likely next pages for instant loading */}}
{{ if eq .RelPermalink "/" }}
  <link rel="prerender" href="/microblog/posts/">
{{ else if eq .Section "posts" }}
  <link rel="prerender" href="/microblog/tags/">
{{ else if eq .RelPermalink "/tags/" }}
  <link rel="prerender" href="/microblog/about/">
{{ end }}

{{/* Appearance switcher functionality */}}
<style>
  .appearance-toggle {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    background: transparent;
    border: none;
    color: currentColor;
    cursor: pointer;
    transition: all 0.2s;
    vertical-align: middle;
    line-height: 1;
  }
  
  .appearance-toggle:hover {
    color: rgb(107, 114, 128);
  }
  
  .dark .appearance-toggle:hover {
    color: rgb(156, 163, 175);
  }
  
  .appearance-toggle svg {
    width: 1.125rem;
    height: 1.125rem;
    display: block;
  }
  
  /* Match the Tags link styling */
  .desktop-appearance-item {
    display: inline-flex;
    align-items: center;
  }
  
  .desktop-appearance-item .appearance-toggle {
    text-decoration: none;
    font-size: inherit;
    font-weight: inherit;
  }
  
  /* Mobile menu styling */
  .mobile-appearance-item {
    margin-bottom: 1rem;
    text-align: right;
  }
  
  .mobile-appearance-item button {
    width: 100%;
    text-align: right;
    justify-content: flex-end;
    display: flex;
    align-items: center;
    padding: 0.375rem 0;
  }
  
  /* Desktop menu styling */
  @media (min-width: 640px) {
    .desktop-appearance-item {
      margin-bottom: 0;
      margin-right: 1.75rem;
    }
    .desktop-appearance-item:last-child {
      margin-right: 0;
    }
  }
</style>

<script>
  // Enhanced prefetching on hover
  document.addEventListener('DOMContentLoaded', function() {
    // Prefetch pages when hovering over navigation links
    const navLinks = document.querySelectorAll('a[href*="/microblog/"]');
    const prefetchedUrls = new Set();
    
    navLinks.forEach(link => {
      link.addEventListener('mouseenter', function() {
        const href = this.href;
        if (!prefetchedUrls.has(href) && href !== window.location.href) {
          prefetchedUrls.add(href);
          const prefetchLink = document.createElement('link');
          prefetchLink.rel = 'prefetch';
          prefetchLink.href = href;
          document.head.appendChild(prefetchLink);
        }
      });
    });
  });

  // Add appearance switcher to navigation
  window.addEventListener('DOMContentLoaded', function() {
    // For desktop menu
    const desktopMenu = document.querySelector('ul.hidden.list-none.flex-row.text-end.sm\\:flex');
    if (desktopMenu) {
      const li = document.createElement('li');
      li.className = 'group mb-1 sm:mb-0 sm:me-7 sm:last:me-0 desktop-appearance-item';
      li.innerHTML = `
        <a href="#" class="appearance-toggle decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2" onclick="event.preventDefault(); toggleAppearance();" aria-label="Toggle appearance">
          <span class="inline dark:hidden">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
            </svg>
          </span>
          <span class="hidden dark:inline">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
            </svg>
          </span>
        </a>
      `;
      desktopMenu.appendChild(li);
    }
    
    // For mobile menu - find the ul inside the menu dropdown
    const mobileMenus = document.querySelectorAll('ul.mx-auto.flex.w-full.max-w-7xl.list-none');
    mobileMenus.forEach(function(mobileMenu) {
      // Find the closing X button li
      const closeLi = mobileMenu.querySelector('li:first-child');
      if (closeLi) {
        const li = document.createElement('li');
        li.className = 'group mb-1 mobile-appearance-item';
        li.innerHTML = `
          <button class="appearance-toggle w-full hover:text-primary-600 dark:hover:text-primary-400" onclick="toggleAppearance(); close_menu();" aria-label="Toggle appearance" style="text-align: right; display: flex; justify-content: flex-end; align-items: center;">
            <span class="inline dark:hidden">
              Light Mode
            </span>
            <span class="hidden dark:inline">
              Dark Mode
            </span>
          </button>
        `;
        // Insert after the last menu item
        mobileMenu.appendChild(li);
      }
    });
  });
  
  function toggleAppearance() {
    const html = document.documentElement;
    const isDark = html.classList.contains('dark');
    
    if (isDark) {
      html.classList.remove('dark');
      localStorage.setItem('appearance', 'light');
    } else {
      html.classList.add('dark');
      localStorage.setItem('appearance', 'dark');
    }
  }
  
  // Close mobile menu function (if it doesn't exist)
  if (typeof close_menu === 'undefined') {
    window.close_menu = function() {
      const menuController = document.getElementById('menu-controller');
      if (menuController) {
        menuController.checked = false;
      }
    }
  }
</script>

{{/* Force page title to always be Cui.Yingyun */}}
<script>
  // Set title immediately
  document.title = "Cui.Yingyun";
  
  // Monitor and override any title changes
  (function() {
    const targetNode = document.querySelector('title');
    if (targetNode) {
      const observer = new MutationObserver(function(mutations) {
        if (document.title !== "Cui.Yingyun") {
          document.title = "Cui.Yingyun";
        }
      });
      observer.observe(targetNode, { childList: true, characterData: true, subtree: true });
    }
    
    // Also override on DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function() {
      document.title = "Cui.Yingyun";
    });
    
    // Override on page visibility change
    document.addEventListener('visibilitychange', function() {
      if (document.title !== "Cui.Yingyun") {
        document.title = "Cui.Yingyun";
      }
    });
  })();
</script>

{{/* Force override all link colors inline */}}
<style>
  /* Absolute final override for ALL links */
  a, a:link, a:visited, a:hover, a:active, a:focus,
  .prose a, .prose a:link, .prose a:visited, .prose a:hover,
  .prose-neutral a, article a, .content a,
  a[href^="mailto:"], a[href^="mailto:"]:hover,
  a[href^="mailto:"]:visited, a[href^="mailto:"]:active {
    color: currentColor !important;
    text-decoration: none !important;
  }
  
  .prose a, article a, .content a, a[href^="mailto:"] {
    color: #000000 !important;
  }
  
  .dark .prose a, .dark article a, .dark .content a, .dark a[href^="mailto:"] {
    color: #ffffff !important;
  }
  
  /* Remove any theme primary colors */
  :root {
    --color-primary-50: #f5f5f5;
    --color-primary-100: #e0e0e0;
    --color-primary-200: #bdbdbd;
    --color-primary-300: #9e9e9e;
    --color-primary-400: #757575;
    --color-primary-500: #616161;
    --color-primary-600: #424242;
    --color-primary-700: #303030;
    --color-primary-800: #212121;
    --color-primary-900: #000000;
  }
</style>

{{/* Load html2canvas library for image generation */}}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

{{/* Extend functionality JavaScript */}}
<script>
// Global variable to store current article title
let currentArticleTitle = '';

// Global fixed width setting for all share image operations
const GLOBAL_SHARE_WIDTH = 400; // ‰øÆÊîπËøô‰∏™Êï∞ÂÄºÊù•Ë∞ÉÊï¥È¢ÑËßàÂíåÁîüÊàêÂõæÁâáÁöÑÂÆΩÂ∫¶

// Á≠âÂæÖÂ≠ó‰ΩìÂä†ËΩΩÂÆåÊàê
async function waitForFonts() {
  if ('fonts' in document) {
    await document.fonts.ready;
    // È¢ùÂ§ñÁ≠âÂæÖÁ°Æ‰øùÂ≠ó‰ΩìÂÆåÂÖ®Ê∏≤Êüì
    await new Promise(resolve => setTimeout(resolve, 200));
  } else {
    // Fallback: wait a bit for fonts to load
    await new Promise(resolve => setTimeout(resolve, 500));
  }
}

// ÂàõÂª∫‰∏Ä‰∏™ÂÆåÂÖ®Áã¨Á´ãÁöÑÊ∏≤ÊüìÂÆπÂô®
function createIsolatedRenderContainer() {
  const container = document.createElement('div');
  container.id = 'isolated-render-container';
  container.style.cssText = `
    position: fixed !important;
    left: -9999px !important;
    top: -9999px !important;
    width: ${GLOBAL_SHARE_WIDTH}px !important;
    height: auto !important;
    background: ${document.documentElement.classList.contains('dark') ? '#0a0a0a' : '#ffffff'} !important;
    border: 1px dashed #d1d5db !important;
    border-radius: 8px !important;
    padding: 2rem !important;
    box-sizing: border-box !important;
    font-family: inherit !important;
    font-size: 1rem !important;
    line-height: 1.75 !important;
    color: ${document.documentElement.classList.contains('dark') ? '#ffffff' : '#111827'} !important;
    overflow: visible !important;
    z-index: -1000 !important;
    visibility: hidden !important;
  `;
  return container;
}

// Render share card to canvas with a fixed width using an isolated container
async function renderShareCanvasWithFixedWidth() {
  const originalCard = document.getElementById('share-card');
  if (!originalCard) {
    throw new Error('Share card not found');
  }

  // Á°Æ‰øùÂ≠ó‰ΩìÂ∑≤Âä†ËΩΩ
  await waitForFonts();

  const width = GLOBAL_SHARE_WIDTH;

  // ÂàõÂª∫ÂÆåÂÖ®Áã¨Á´ãÁöÑÊ∏≤ÊüìÂÆπÂô®
  const renderContainer = createIsolatedRenderContainer();
  
  // Ëé∑ÂèñÊñáÁ´†ÂÜÖÂÆπ
  const articleContent = originalCard.querySelector('.share-article-content');
  const shareDate = originalCard.querySelector('.share-date');
  
  // ÂàõÂª∫ÂÜÖÂÆπÁªìÊûÑ
  const contentDiv = document.createElement('div');
  contentDiv.style.cssText = `
    margin-bottom: 2rem !important;
    overflow-wrap: break-word !important;
    word-wrap: break-word !important;
    word-break: break-word !important;
    display: block !important;
  `;
  
  // Â§çÂà∂ÊñáÁ´†ÂÜÖÂÆπ
  if (articleContent) {
    const clonedContent = articleContent.cloneNode(true);
    
    // Ê∏ÖÁêÜ‰∏çÈúÄË¶ÅÁöÑÂÖÉÁ¥†
    const unwantedElements = clonedContent.querySelectorAll('script, button, .extend-button, .extend-menu');
    unwantedElements.forEach(element => element.remove());
    
    // Á¶ÅÁî®ÈìæÊé•
    const links = clonedContent.querySelectorAll('a');
    links.forEach(link => {
      link.removeAttribute('href');
      link.style.pointerEvents = 'none';
    });
    
    // Á¶ÅÁî®ÂõæÁâá
    const images = clonedContent.querySelectorAll('img');
    images.forEach(img => {
      img.removeAttribute('src');
      img.removeAttribute('srcset');
    });
    
    contentDiv.appendChild(clonedContent);
  }
  
  // ÂàõÂª∫Â∫ïÈÉ®‰ø°ÊÅØ
  const footerDiv = document.createElement('div');
  footerDiv.style.cssText = `
    border-top: 1px dashed #d1d5db !important;
    padding-top: 1rem !important;
    margin-top: 0 !important;
  `;
  
  const footerInfo = document.createElement('div');
  footerInfo.style.cssText = `
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    font-size: 0.875rem !important;
    color: ${document.documentElement.classList.contains('dark') ? '#9ca3af' : '#6b7280'} !important;
  `;
  
  const websiteSpan = document.createElement('span');
  websiteSpan.textContent = 'CuiYingyun.com';
  websiteSpan.style.fontWeight = '600';
  
  const dateSpan = document.createElement('span');
  dateSpan.textContent = shareDate ? shareDate.textContent : '';
  dateSpan.style.fontStyle = 'italic';
  
  footerInfo.appendChild(websiteSpan);
  footerInfo.appendChild(dateSpan);
  footerDiv.appendChild(footerInfo);
  
  // ÁªÑË£ÖÂÆπÂô®
  renderContainer.appendChild(contentDiv);
  renderContainer.appendChild(footerDiv);
  
  document.body.appendChild(renderContainer);

  // Á≠âÂæÖÂ∏ÉÂ±ÄÂÆåÊàê
  await new Promise(resolve => requestAnimationFrame(resolve));
  await new Promise(resolve => requestAnimationFrame(resolve));
  await new Promise(resolve => setTimeout(resolve, 300));

  // Ëé∑ÂèñÂÆûÈôÖÈ´òÂ∫¶
  const height = Math.max(renderContainer.offsetHeight, renderContainer.scrollHeight, renderContainer.clientHeight);

  // Ëé∑ÂèñËÉåÊôØËâ≤
  const bgColor = document.documentElement.classList.contains('dark') ? '#0a0a0a' : '#ffffff';

  try {
    const canvas = await html2canvas(renderContainer, {
      scale: 2,
      backgroundColor: bgColor,
      useCORS: false,
      allowTaint: false,
      logging: false,
      foreignObjectRendering: false,
      width: width,
      height: height,
      windowWidth: width,
      windowHeight: height,
      letterRendering: true,
      onclone: (clonedDoc) => {
        // Âú®ÂÖãÈöÜÊñáÊ°£‰∏≠Á°Æ‰øùÊ†∑ÂºèÊ≠£Á°Æ
        const clonedContainer = clonedDoc.querySelector('#isolated-render-container');
        if (clonedContainer) {
          clonedContainer.style.width = width + 'px';
          clonedContainer.style.height = 'auto';
        }
      }
    });
    document.body.removeChild(renderContainer);
    return canvas;
  } catch (err) {
    document.body.removeChild(renderContainer);
    throw err;
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // Add event listeners to all extend buttons
  document.querySelectorAll('.extend-button').forEach(function(button) {
    button.addEventListener('click', function(e) {
      e.stopPropagation();
      
      // Get corresponding menu element
      const menu = this.nextElementSibling;
      
      // Close all other open menus
      document.querySelectorAll('.extend-menu').forEach(function(otherMenu) {
        if (otherMenu !== menu) {
          otherMenu.classList.add('hidden');
          otherMenu.classList.remove('show');
        }
      });
      
      // Toggle current menu display state
      if (menu.classList.contains('hidden')) {
        menu.classList.remove('hidden');
        menu.classList.add('show');
      } else {
        menu.classList.add('hidden');
        menu.classList.remove('show');
      }
    });
  });

  // Add event listeners to menu items
  document.querySelectorAll('.extend-menu-item').forEach(function(item) {
    item.addEventListener('click', function(e) {
      e.stopPropagation();
      
      const action = this.getAttribute('data-action');
      const button = this.closest('.post-meta').querySelector('.extend-button');
      
      if (action === 'copy-markdown') {
        copyAsMarkdown(button);
      } else if (action === 'generate-share-image') {
        generateShareImage(button);
      }
      
      // Close menu
      const menu = this.closest('.extend-menu');
      menu.classList.add('hidden');
      menu.classList.remove('show');
    });
  });

  // Close all menus when clicking elsewhere on page
  document.addEventListener('click', function() {
    document.querySelectorAll('.extend-menu').forEach(function(menu) {
      menu.classList.add('hidden');
      menu.classList.remove('show');
    });
  });

  // Prevent menu clicks from bubbling to document
  document.querySelectorAll('.extend-menu').forEach(function(menu) {
    menu.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  });

  // Copy as Markdown function
  function copyAsMarkdown(button) {
    try {
      const content = button.getAttribute('data-content');
      
      // Build Markdown content - only keep body content
      let markdownContent = '';
      
      // Add content
      if (content && content.trim() !== '') {
        // Decode HTML entities
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = content;
        markdownContent = tempDiv.textContent || tempDiv.innerText || '';
      }
      
      // Use modern Clipboard API
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(markdownContent).then(function() {
          showCopySuccess('Markdown content copied to clipboard');
        }).catch(function(err) {
          console.error('Copy failed:', err);
          fallbackCopy(markdownContent);
        });
      } else {
        // Fallback solution
        fallbackCopy(markdownContent);
      }
    } catch (error) {
      console.error('Error during copy process:', error);
      showCopyError('Copy failed, please try again');
    }
  }

  // Fallback copy solution
  function fallbackCopy(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
      const successful = document.execCommand('copy');
      if (successful) {
        showCopySuccess('Markdown content copied to clipboard');
      } else {
        showCopyError('Copy failed, please copy manually');
      }
    } catch (err) {
      console.error('Fallback copy also failed:', err);
      showCopyError('Copy failed, please copy manually');
    }
    
    document.body.removeChild(textArea);
  }

  // Show copy success notification
  function showCopySuccess(message) {
    showNotification(message, 'success');
  }

  // Show copy error notification
  function showCopyError(message) {
    showNotification(message, 'error');
  }

  // General notification function
  function showNotification(message, type) {
    // Remove existing notification
    const existingNotification = document.querySelector('.copy-notification');
    if (existingNotification) {
      existingNotification.remove();
    }

    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'copy-notification';
    notification.textContent = message;
    
    // Set styles
    const baseStyles = {
      position: 'fixed',
      top: '20px',
      right: '20px',
      padding: '12px 16px',
      borderRadius: '6px',
      fontSize: '14px',
      fontWeight: '500',
      zIndex: '10000',
      maxWidth: '300px',
      wordWrap: 'break-word',
      transition: 'all 0.3s ease'
    };
    
    const typeStyles = type === 'success' 
      ? {
          backgroundColor: '#8b5cf6',
          color: '#ffffff',
          border: '1px solid #7c3aed'
        }
      : {
          backgroundColor: '#ef4444',
          color: '#ffffff',
          border: '1px solid #dc2626'
        };
    
    Object.assign(notification.style, baseStyles, typeStyles);
    
    // Add to page
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(function() {
      if (notification.parentNode) {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(function() {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 300);
      }
    }, 3000);
  }

  // Generate share image function
  function generateShareImage(button) {
    try {
      // Get the rendered HTML content from the current article
      const article = button.closest('.microblog-post');
      const renderedContent = article.querySelector('.prose');
      const title = button.getAttribute('data-title');
      const date = button.getAttribute('data-date');
      
      // Show modal with rendered content
      showShareImageModal(renderedContent, title, date);
    } catch (error) {
      console.error('Error generating share image:', error);
      showCopyError('Failed to generate share image');
    }
  }

  // Show share image modal
  function showShareImageModal(contentElement, title, date) {
    const modal = document.getElementById('share-image-modal');
    const articleContent = modal.querySelector('.share-article-content');
    const shareDate = modal.querySelector('.share-date');
    const shareCard = modal.querySelector('.share-card');
    
    // Store article title globally for filename
    currentArticleTitle = title || '';
    
    // ‰ΩøÁî®‰∏éÊ∏≤ÊüìÂÆåÂÖ®Áõ∏ÂêåÁöÑÊ†∑ÂºèËÆæÁΩÆ
    shareCard.style.cssText = `
      width: ${GLOBAL_SHARE_WIDTH}px !important;
      min-width: ${GLOBAL_SHARE_WIDTH}px !important;
      max-width: ${GLOBAL_SHARE_WIDTH}px !important;
      height: auto !important;
      min-height: auto !important;
      max-height: none !important;
      margin: 0 auto !important;
      display: block !important;
      position: relative !important;
      box-sizing: border-box !important;
      overflow: visible !important;
      background: ${document.documentElement.classList.contains('dark') ? '#0a0a0a' : '#ffffff'} !important;
      border: 1px dashed #d1d5db !important;
      border-radius: 8px !important;
      padding: 2rem !important;
      font-family: inherit !important;
      font-size: 1rem !important;
      line-height: 1.75 !important;
      color: ${document.documentElement.classList.contains('dark') ? '#ffffff' : '#111827'} !important;
    `;
    
    // ËÆæÁΩÆÂÜÖÂÆπÂå∫ÂüüÊ†∑Âºè
    articleContent.style.cssText = `
      margin-bottom: 2rem !important;
      overflow-wrap: break-word !important;
      word-wrap: break-word !important;
      word-break: break-word !important;
      display: block !important;
      line-height: 1.75 !important;
    `;
    
    // Copy the rendered HTML content directly
    if (contentElement && contentElement.innerHTML) {
      // Clone the content to avoid modifying the original
      const clonedContent = contentElement.cloneNode(true);
      
      // Remove any unwanted elements (like scripts, buttons, etc.)
      const unwantedElements = clonedContent.querySelectorAll('script, button, .extend-button, .extend-menu');
      unwantedElements.forEach(element => element.remove());
      
      // Á¶ÅÁî®ÈìæÊé•
      const links = clonedContent.querySelectorAll('a');
      links.forEach(link => {
        link.removeAttribute('href');
        link.style.pointerEvents = 'none';
      });
      
      // Á¶ÅÁî®ÂõæÁâá
      const images = clonedContent.querySelectorAll('img');
      images.forEach(img => {
        img.removeAttribute('src');
        img.removeAttribute('srcset');
      });
      
      // Ensure list styles are preserved
      const lists = clonedContent.querySelectorAll('ul, ol');
      lists.forEach(list => {
        if (!list.style.listStyleType) {
          if (list.tagName === 'UL') {
            list.style.listStyleType = 'disc';
          } else if (list.tagName === 'OL') {
            list.style.listStyleType = 'decimal';
          }
        }
      });
      
      // Set the content
      articleContent.innerHTML = clonedContent.innerHTML;
    } else {
      articleContent.innerHTML = '<p>No content available</p>';
    }
    
    // ËÆæÁΩÆÂ∫ïÈÉ®Âå∫ÂüüÊ†∑Âºè
    const shareCardFooter = shareCard.querySelector('.share-card-footer');
    if (shareCardFooter) {
      shareCardFooter.style.cssText = `
        border-top: 1px dashed #d1d5db !important;
        padding-top: 1rem !important;
        margin-top: 0 !important;
      `;
    }
    
    const shareFooterInfo = shareCard.querySelector('.share-footer-info');
    if (shareFooterInfo) {
      shareFooterInfo.style.cssText = `
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        font-size: 0.875rem !important;
        color: ${document.documentElement.classList.contains('dark') ? '#9ca3af' : '#6b7280'} !important;
      `;
    }
    
    // Format and set date
    const formattedDate = formatShareDate(date);
    shareDate.textContent = formattedDate;
    
    // Show modal
    modal.classList.remove('hidden');
    setTimeout(() => {
      modal.classList.add('show');
    }, 10);
  }

  // Format article content with proper styling
  function formatArticleContent(rawContent, title) {
    if (!rawContent || rawContent.trim() === '') {
      return '<p>No content available</p>';
    }
    
    // Decode HTML entities
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = rawContent;
    let content = tempDiv.textContent || tempDiv.innerText || '';
    
    // Convert Markdown-like syntax to HTML
    let html = '';
    
    // Skip title - only include body content
    
    // Process content line by line
    const lines = content.split('\n');
    let inCodeBlock = false;
    let codeBlockContent = '';
    
    for (let i = 0; i < lines.length; i++) {
      let line = lines[i];
      
      // Handle code blocks
      if (line.trim().startsWith('```')) {
        if (inCodeBlock) {
          // End code block
          html += '<pre><code>' + escapeHtml(codeBlockContent.trim()) + '</code></pre>\n';
          codeBlockContent = '';
          inCodeBlock = false;
        } else {
          // Start code block
          inCodeBlock = true;
        }
        continue;
      }
      
      if (inCodeBlock) {
        codeBlockContent += line + '\n';
        continue;
      }
      
      // Handle headings
      if (line.trim().startsWith('### ')) {
        html += '<h3>' + escapeHtml(line.trim().substring(4)) + '</h3>\n';
      } else if (line.trim().startsWith('## ')) {
        html += '<h2>' + escapeHtml(line.trim().substring(3)) + '</h2>\n';
      } else if (line.trim().startsWith('# ')) {
        html += '<h1>' + escapeHtml(line.trim().substring(2)) + '</h1>\n';
      }
      // Handle list items
      else if (line.trim().startsWith('- ') || line.trim().startsWith('* ')) {
        html += '<li>' + escapeHtml(line.trim().substring(2)) + '</li>\n';
      }
      // Handle numbered lists
      else if (/^\d+\.\s/.test(line.trim())) {
        html += '<li>' + escapeHtml(line.trim().replace(/^\d+\.\s/, '')) + '</li>\n';
      }
      // Handle inline code
      else if (line.trim() !== '') {
        let processedLine = escapeHtml(line.trim());
        // Convert `code` to <code>code</code>
        processedLine = processedLine.replace(/`([^`]+)`/g, '<code>$1</code>');
        html += '<p>' + processedLine + '</p>\n';
      }
      // Handle empty lines
      else {
        html += '\n';
      }
    }
    
    return html;
  }

  // Format date for share image
  function formatShareDate(dateString) {
    if (!dateString) return '';
    
    try {
      const date = new Date(dateString);
      const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const weekday = weekdays[date.getDay()];
      
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      
      return `${year}/${month}/${day} (${weekday})`;
    } catch (error) {
      return dateString;
    }
  }

  // Escape HTML entities
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Generate filename from article title
  function getArticleFilename() {
    if (!currentArticleTitle || currentArticleTitle.trim() === '') {
      return 'share-image.png';
    }
    
    // Clean the title for use as filename
    let filename = currentArticleTitle
      .trim()
      .replace(/[^\w\s\-\u4e00-\u9fff]/g, '') // Keep only alphanumeric, spaces, hyphens, and Chinese characters
      .replace(/\s+/g, '-') // Replace spaces with hyphens
      .replace(/-+/g, '-') // Replace multiple hyphens with single hyphen
      .replace(/^-+|-+$/g, ''); // Remove leading/trailing hyphens
    
    // Limit filename length
    if (filename.length > 50) {
      filename = filename.substring(0, 50);
    }
    
    // Add .png extension
    return filename + '.png';
  }

  // Close share image modal
  function closeShareImageModal() {
    const modal = document.getElementById('share-image-modal');
    modal.classList.remove('show');
    setTimeout(() => {
      modal.classList.add('hidden');
    }, 300);
  }

  // Download share image
  function downloadShareImage() {
    // Show loading state
    const downloadBtn = document.querySelector('.share-download-btn');
    const originalText = downloadBtn.textContent;
    downloadBtn.textContent = 'Generating...';
    downloadBtn.disabled = true;
    
    renderShareCanvasWithFixedWidth().then(function(canvas) {
      // Get article title for filename
      const filename = getArticleFilename();
      
      // Create download link
      const link = document.createElement('a');
      link.download = filename;
      link.href = canvas.toDataURL();
      
      // Trigger download
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Reset button
      downloadBtn.textContent = originalText;
      downloadBtn.disabled = false;
      
      showCopySuccess('Share image downloaded successfully');
    }).catch(function(error) {
      console.error('Error generating image:', error);
      downloadBtn.textContent = originalText;
      downloadBtn.disabled = false;
      showCopyError('Failed to generate image');
    });
  }

  // Copy share image to clipboard
  function copyShareImage() {
    // Show loading state
    const copyBtn = document.querySelector('.share-copy-btn');
    const originalText = copyBtn.textContent;
    copyBtn.textContent = 'Copying...';
    copyBtn.disabled = true;
    
    renderShareCanvasWithFixedWidth().then(function(canvas) {
      // Convert canvas to blob
      canvas.toBlob(function(blob) {
        if (navigator.clipboard && window.ClipboardItem) {
          // Use modern Clipboard API
          const item = new ClipboardItem({ 'image/png': blob });
          navigator.clipboard.write([item]).then(function() {
            // Reset button
            copyBtn.textContent = originalText;
            copyBtn.disabled = false;
            showCopySuccess('Share image copied to clipboard');
          }).catch(function(error) {
            console.error('Failed to copy image:', error);
            copyBtn.textContent = originalText;
            copyBtn.disabled = false;
            showCopyError('Failed to copy image to clipboard');
          });
        } else {
          // Fallback: show a message that copying is not supported
          copyBtn.textContent = originalText;
          copyBtn.disabled = false;
          showCopyError('Image copy not supported in this browser');
        }
      }, 'image/png');
    }).catch(function(error) {
      console.error('Error generating image for copy:', error);
      copyBtn.textContent = originalText;
      copyBtn.disabled = false;
      showCopyError('Failed to copy image');
    });
  }

  // Add modal event listeners
  document.addEventListener('click', function(e) {
    // Close modal when clicking outside
    if (e.target.classList.contains('share-modal')) {
      closeShareImageModal();
    }
    
    // Close modal when clicking close button
    if (e.target.classList.contains('share-modal-close')) {
      closeShareImageModal();
    }
    
    // Download image when clicking download button
    if (e.target.classList.contains('share-download-btn')) {
      downloadShareImage();
    }
    
    // Copy image when clicking copy button
    if (e.target.classList.contains('share-copy-btn')) {
      copyShareImage();
    }
  });

  // Close modal with Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const modal = document.getElementById('share-image-modal');
      if (modal && !modal.classList.contains('hidden')) {
        closeShareImageModal();
      }
    }
  });
});
</script> 