{{/* 添加透明的favicon以替换紫色方框 */}}
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='50' x='50' text-anchor='middle' dominant-baseline='central' font-size='80'>👤</text></svg>">
<link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='50' x='50' text-anchor='middle' dominant-baseline='central' font-size='80'>👤</text></svg>">

{{/* Load custom CSS */}}
{{ $customCSS := resources.Get "css/custom.css" | resources.Minify | resources.Fingerprint }}
<link rel="stylesheet" href="{{ $customCSS.RelPermalink }}" integrity="{{ $customCSS.Data.Integrity }}" />

{{/* Initialize dark mode immediately to prevent flash */}}
<script>
  // Apply dark mode immediately if saved in localStorage
  (function() {
    if (localStorage.getItem('appearance') === 'dark' || 
        (!localStorage.getItem('appearance') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
    }
  })();
</script>

{{/* Enhanced preloading strategy */}}
{{/* DNS prefetch for external resources */}}
<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="dns-prefetch" href="//fonts.gstatic.com">

{{/* Preconnect to speed up font loading */}}
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

{{/* Prefetch navigation pages */}}
<link rel="prefetch" href="/microblog/posts/">
<link rel="prefetch" href="/microblog/tags/">
<link rel="prefetch" href="/microblog/about/">

{{/* Prerender the most likely next pages for instant loading */}}
{{ if eq .RelPermalink "/" }}
  <link rel="prerender" href="/microblog/posts/">
{{ else if eq .Section "posts" }}
  <link rel="prerender" href="/microblog/tags/">
{{ else if eq .RelPermalink "/tags/" }}
  <link rel="prerender" href="/microblog/about/">
{{ end }}

{{/* Appearance switcher functionality */}}
<style>
  .appearance-toggle {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    background: transparent;
    border: none;
    color: currentColor;
    cursor: pointer;
    transition: all 0.2s;
    vertical-align: middle;
    line-height: 1;
  }
  
  .appearance-toggle:hover {
    color: rgb(107, 114, 128);
  }
  
  .dark .appearance-toggle:hover {
    color: rgb(156, 163, 175);
  }
  
  .appearance-toggle svg {
    width: 1.125rem;
    height: 1.125rem;
    display: block;
  }
  
  /* Match the Tags link styling */
  .desktop-appearance-item {
    display: inline-flex;
    align-items: center;
  }
  
  .desktop-appearance-item .appearance-toggle {
    text-decoration: none;
    font-size: inherit;
    font-weight: inherit;
  }
  
  /* Mobile menu styling */
  .mobile-appearance-item {
    margin-bottom: 1rem;
    text-align: right;
  }
  
  .mobile-appearance-item button {
    width: 100%;
    text-align: right;
    justify-content: flex-end;
    display: flex;
    align-items: center;
    padding: 0.375rem 0;
  }
  
  /* Desktop menu styling */
  @media (min-width: 640px) {
    .desktop-appearance-item {
      margin-bottom: 0;
      margin-right: 1.75rem;
    }
    .desktop-appearance-item:last-child {
      margin-right: 0;
    }
  }
</style>

<script>
  // Enhanced prefetching on hover
  document.addEventListener('DOMContentLoaded', function() {
    // Prefetch pages when hovering over navigation links
    const navLinks = document.querySelectorAll('a[href*="/microblog/"]');
    const prefetchedUrls = new Set();
    
    navLinks.forEach(link => {
      link.addEventListener('mouseenter', function() {
        const href = this.href;
        if (!prefetchedUrls.has(href) && href !== window.location.href) {
          prefetchedUrls.add(href);
          const prefetchLink = document.createElement('link');
          prefetchLink.rel = 'prefetch';
          prefetchLink.href = href;
          document.head.appendChild(prefetchLink);
        }
      });
    });
  });

  // Add appearance switcher to navigation
  window.addEventListener('DOMContentLoaded', function() {
    // For desktop menu
    const desktopMenu = document.querySelector('ul.hidden.list-none.flex-row.text-end.sm\\:flex');
    if (desktopMenu) {
      const li = document.createElement('li');
      li.className = 'group mb-1 sm:mb-0 sm:me-7 sm:last:me-0 desktop-appearance-item';
      li.innerHTML = `
        <a href="#" class="appearance-toggle decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2" onclick="event.preventDefault(); toggleAppearance();" aria-label="Toggle appearance">
          <span class="inline dark:hidden">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
            </svg>
          </span>
          <span class="hidden dark:inline">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
            </svg>
          </span>
        </a>
      `;
      desktopMenu.appendChild(li);
    }
    
    // For mobile menu - find the ul inside the menu dropdown
    const mobileMenus = document.querySelectorAll('ul.mx-auto.flex.w-full.max-w-7xl.list-none');
    mobileMenus.forEach(function(mobileMenu) {
      // Find the closing X button li
      const closeLi = mobileMenu.querySelector('li:first-child');
      if (closeLi) {
        const li = document.createElement('li');
        li.className = 'group mb-1 mobile-appearance-item';
        li.innerHTML = `
          <button class="appearance-toggle w-full hover:text-primary-600 dark:hover:text-primary-400" onclick="toggleAppearance(); close_menu();" aria-label="Toggle appearance" style="text-align: right; display: flex; justify-content: flex-end; align-items: center;">
            <span class="inline dark:hidden">
              Light Mode
            </span>
            <span class="hidden dark:inline">
              Dark Mode
            </span>
          </button>
        `;
        // Insert after the last menu item
        mobileMenu.appendChild(li);
      }
    });
  });
  
  function toggleAppearance() {
    const html = document.documentElement;
    const isDark = html.classList.contains('dark');
    
    if (isDark) {
      html.classList.remove('dark');
      localStorage.setItem('appearance', 'light');
    } else {
      html.classList.add('dark');
      localStorage.setItem('appearance', 'dark');
    }
  }
  
  // Close mobile menu function (if it doesn't exist)
  if (typeof close_menu === 'undefined') {
    window.close_menu = function() {
      const menuController = document.getElementById('menu-controller');
      if (menuController) {
        menuController.checked = false;
      }
    }
  }
</script>

{{/* Force page title to always be Cui.Yingyun */}}
<script>
  // Set title immediately
  document.title = "Cui.Yingyun";
  
  // Monitor and override any title changes
  (function() {
    const targetNode = document.querySelector('title');
    if (targetNode) {
      const observer = new MutationObserver(function(mutations) {
        if (document.title !== "Cui.Yingyun") {
          document.title = "Cui.Yingyun";
        }
      });
      observer.observe(targetNode, { childList: true, characterData: true, subtree: true });
    }
    
    // Also override on DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function() {
      document.title = "Cui.Yingyun";
    });
    
    // Override on page visibility change
    document.addEventListener('visibilitychange', function() {
      if (document.title !== "Cui.Yingyun") {
        document.title = "Cui.Yingyun";
      }
    });
  })();
</script>

{{/* Force override all link colors inline */}}
<style>
  /* Absolute final override for ALL links */
  a, a:link, a:visited, a:hover, a:active, a:focus,
  .prose a, .prose a:link, .prose a:visited, .prose a:hover,
  .prose-neutral a, article a, .content a,
  a[href^="mailto:"], a[href^="mailto:"]:hover,
  a[href^="mailto:"]:visited, a[href^="mailto:"]:active {
    color: currentColor !important;
    text-decoration: none !important;
  }
  
  .prose a, article a, .content a, a[href^="mailto:"] {
    color: #000000 !important;
  }
  
  .dark .prose a, .dark article a, .dark .content a, .dark a[href^="mailto:"] {
    color: #ffffff !important;
  }
  
  /* Remove any theme primary colors */
  :root {
    --color-primary-50: #f5f5f5;
    --color-primary-100: #e0e0e0;
    --color-primary-200: #bdbdbd;
    --color-primary-300: #9e9e9e;
    --color-primary-400: #757575;
    --color-primary-500: #616161;
    --color-primary-600: #424242;
    --color-primary-700: #303030;
    --color-primary-800: #212121;
    --color-primary-900: #000000;
  }
</style>

{{/* Load html2canvas library for image generation */}}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

{{/* Extend functionality JavaScript */}}
<script>
// ================================
// 🎛️ 调试参数配置 - 在这里调整各项参数
// ================================
const DEBUG_CONFIG = {
  // 🖼️ 图片尺寸配置
  shareWidth: 400,           // 分享图片宽度 (px)
  imageScale: 2.8,             // 图片分辨率缩放 (1=标准, 2=高清, 3=超高清)
  
  // 📝 文字样式配置
  websiteFontSize: 1.3,    // 网站名称字体大小 (rem) (建议范围: 0.7-1.2)
  dateFontSize: 0.8,       // 日期字体大小 (rem) (建议范围: 0.7-1.2)
  lineHeight: 1.6,           // 行高倍数 (建议范围: 1.1-1.4)
  paragraphSpacing: 0.7,     // 段落间距 (rem) (建议范围: 0.3-1.0)
  letterSpacing: '0.01em',   // 字符间距
  
  // 🎨 边框样式配置
  borderWidth: 2.5,            // 图片生成预览卡片中的虚线边框宽度 (px) (建议范围: 1-5)
  
  // 📏 间距配置
  cardPadding: 2,            // 卡片内边距 (rem)
  contentBottomMargin: 1,    // 内容区域底部间距 (rem)
  footerPadding: 1,          // 底部区域上下内边距 (rem) (建议范围: 0.5-2.0)
  
  // 🎨 渲染配置
  imageTimeout: 20000,       // 图片生成超时时间 (ms)
  fontWaitTime: 500,         // 字体加载等待时间 (ms)
  
  // 🐛 调试配置
  enableDebugLogs: true,     // 启用调试日志
};

// Global variables
let currentArticleTitle = '';

// 从调试配置获取分享图片宽度
const GLOBAL_SHARE_WIDTH = DEBUG_CONFIG.shareWidth;

// 将调试配置应用到CSS自定义属性
function applyDebugConfigToCSS() {
  const root = document.documentElement;
  root.style.setProperty('--debug-website-font-size', DEBUG_CONFIG.websiteFontSize + 'rem');
  root.style.setProperty('--debug-date-font-size', DEBUG_CONFIG.dateFontSize + 'rem');
  root.style.setProperty('--debug-border-width', DEBUG_CONFIG.borderWidth + 'px');
  root.style.setProperty('--debug-footer-padding', DEBUG_CONFIG.footerPadding + 'rem');
  root.style.setProperty('--debug-line-height', DEBUG_CONFIG.lineHeight);
  root.style.setProperty('--debug-paragraph-spacing', DEBUG_CONFIG.paragraphSpacing + 'rem');
  root.style.setProperty('--debug-letter-spacing', DEBUG_CONFIG.letterSpacing);
  root.style.setProperty('--debug-card-padding', DEBUG_CONFIG.cardPadding + 'rem');
}

// 页面加载时应用配置
document.addEventListener('DOMContentLoaded', function() {
  applyDebugConfigToCSS();
  createDebugPanel();
});

// 创建调试面板
function createDebugPanel() {
  // 检查是否已存在调试面板
  if (document.getElementById('debug-panel')) return;
  
  const debugPanel = document.createElement('div');
  debugPanel.id = 'debug-panel';
  debugPanel.style.cssText = `
    position: fixed;
    top: 10px;
    right: 10px;
    width: 300px;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 15px;
    border-radius: 8px;
    z-index: 10000;
    font-family: monospace;
    font-size: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    display: none;
  `;
  
  debugPanel.innerHTML = `
    <div style="margin-bottom: 10px; font-weight: bold; color: #a855f7;">🎛️ 分享卡片调试面板</div>
    
    <div style="margin-bottom: 8px;">
      <label>网站名称字体: <span id="website-font-size-value">${DEBUG_CONFIG.websiteFontSize}</span>rem</label>
      <input type="range" id="website-font-size-slider" min="0.7" max="1.5" step="0.05" value="${DEBUG_CONFIG.websiteFontSize}" style="width: 100%; margin-top: 3px;">
    </div>
    
    <div style="margin-bottom: 8px;">
      <label>日期字体大小: <span id="date-font-size-value">${DEBUG_CONFIG.dateFontSize}</span>rem</label>
      <input type="range" id="date-font-size-slider" min="0.7" max="1.2" step="0.05" value="${DEBUG_CONFIG.dateFontSize}" style="width: 100%; margin-top: 3px;">
    </div>
    
    <div style="margin-bottom: 8px;">
      <label>虚线粗细: <span id="border-width-value">${DEBUG_CONFIG.borderWidth}</span>px</label>
      <input type="range" id="border-width-slider" min="1" max="5" step="0.5" value="${DEBUG_CONFIG.borderWidth}" style="width: 100%; margin-top: 3px;">
    </div>
    
    <div style="margin-bottom: 8px;">
      <label>底部区域高度: <span id="footer-padding-value">${DEBUG_CONFIG.footerPadding}</span>rem</label>
      <input type="range" id="footer-padding-slider" min="0.3" max="2.0" step="0.1" value="${DEBUG_CONFIG.footerPadding}" style="width: 100%; margin-top: 3px;">
    </div>
    
    <div style="margin-top: 10px;">
      <button id="apply-debug-config" style="background: #a855f7; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; width: 100%;">应用设置</button>
    </div>
    
    <div style="margin-top: 5px;">
      <button id="reset-debug-config" style="background: #6b7280; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; width: 100%;">重置默认</button>
    </div>
  `;
  
  document.body.appendChild(debugPanel);
  
  // 绑定滑块事件
  const sliders = [
    { id: 'website-font-size', config: 'websiteFontSize', display: 'website-font-size-value' },
    { id: 'date-font-size', config: 'dateFontSize', display: 'date-font-size-value' },
    { id: 'border-width', config: 'borderWidth', display: 'border-width-value' },
    { id: 'footer-padding', config: 'footerPadding', display: 'footer-padding-value' }
  ];
  
  sliders.forEach(slider => {
    const sliderElement = document.getElementById(slider.id + '-slider');
    const displayElement = document.getElementById(slider.display);
    
    sliderElement.addEventListener('input', function() {
      const value = parseFloat(this.value);
      DEBUG_CONFIG[slider.config] = value;
      displayElement.textContent = value;
    });
  });
  
  // 应用设置按钮
  document.getElementById('apply-debug-config').addEventListener('click', function() {
    applyDebugConfigToCSS();
    debugLog('🎛️ 调试配置已应用', DEBUG_CONFIG);
    debugLog('底部区域配置', { 
      footerPadding: DEBUG_CONFIG.footerPadding + 'rem'
    });
    
    // 如果分享模态框是打开的，重新应用样式
    const modal = document.getElementById('share-image-modal');
    if (modal && modal.style.display !== 'none') {
      const shareCard = modal.querySelector('.share-card');
      if (shareCard) {
        // 更新网站名称和日期字体大小
        const shareWebsite = shareCard.querySelector('.share-website');
        if (shareWebsite) {
          shareWebsite.style.fontSize = `${DEBUG_CONFIG.websiteFontSize}rem !important`;
        }
        
        const shareDate = shareCard.querySelector('.share-date');
        if (shareDate) {
          shareDate.style.fontSize = `${DEBUG_CONFIG.dateFontSize}rem !important`;
        }
        
        // 更新虚线边框宽度和底部区域高度
        shareCard.style.borderWidth = `${DEBUG_CONFIG.borderWidth}px`;
        const shareCardFooter = shareCard.querySelector('.share-card-footer');
        if (shareCardFooter) {
          shareCardFooter.style.borderTopWidth = `${DEBUG_CONFIG.borderWidth}px`;
          shareCardFooter.style.padding = `${DEBUG_CONFIG.footerPadding}rem 0`;
          shareCardFooter.style.minHeight = `calc(${DEBUG_CONFIG.footerPadding * 2}rem + 1.5rem)`;
          shareCardFooter.style.display = 'flex';
          shareCardFooter.style.alignItems = 'center';
          debugLog('🔧 底部区域样式已更新', {
            padding: shareCardFooter.style.padding,
            minHeight: shareCardFooter.style.minHeight,
            display: shareCardFooter.style.display,
            alignItems: shareCardFooter.style.alignItems
          });
        }
      }
    }
  });
  
  // 重置按钮
  document.getElementById('reset-debug-config').addEventListener('click', function() {
    DEBUG_CONFIG.websiteFontSize = 0.875;
    DEBUG_CONFIG.dateFontSize = 0.875;
    DEBUG_CONFIG.borderWidth = 1;
    DEBUG_CONFIG.footerPadding = 1;
    
    // 更新滑块和显示值
    sliders.forEach(slider => {
      const sliderElement = document.getElementById(slider.id + '-slider');
      const displayElement = document.getElementById(slider.display);
      sliderElement.value = DEBUG_CONFIG[slider.config];
      displayElement.textContent = DEBUG_CONFIG[slider.config];
    });
    
    applyDebugConfigToCSS();
    debugLog('🔄 调试配置已重置为默认值');
  });
}

// 添加快捷键来显示/隐藏调试面板
document.addEventListener('keydown', function(e) {
  // Ctrl+Shift+D 或 Cmd+Shift+D
  if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'D') {
    e.preventDefault();
    const debugPanel = document.getElementById('debug-panel');
    if (debugPanel) {
      debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
      console.log('🎛️ 调试面板', debugPanel.style.display === 'none' ? '隐藏' : '显示');
    }
  }
});

// 调试日志函数
function debugLog(message, data = null) {
  if (DEBUG_CONFIG.enableDebugLogs) {
    const timestamp = new Date().toISOString().substr(11, 12);
    console.log(`🖼️ [${timestamp}] ${message}`, data || '');
  }
}

// 等待字体加载完成
async function waitForFonts() {
  debugLog('开始等待字体加载...');
  
  if ('fonts' in document) {
    debugLog('检测到 document.fonts API，等待字体就绪...');
    await document.fonts.ready;
    
    // 确保所有字体都已加载
    const fontFaces = [...document.fonts];
    debugLog(`发现 ${fontFaces.length} 个字体`, fontFaces.map(f => f.family));
    await Promise.all(fontFaces.map(font => font.loaded));
    
    // 额外等待确保字体完全渲染
    debugLog(`等待 ${DEBUG_CONFIG.fontWaitTime}ms 确保字体渲染完成...`);
    await new Promise(resolve => setTimeout(resolve, DEBUG_CONFIG.fontWaitTime));
  } else {
    debugLog('字体 API 不可用，使用备用等待时间 1000ms');
    await new Promise(resolve => setTimeout(resolve, 1000));
  }
  
  debugLog('字体加载完成 ✅');
}


// Render share card to image using improved html2canvas
async function renderShareImageImproved() {
  debugLog('🚀 开始生成分享图片...');
  
  const shareCard = document.getElementById('share-card');
  if (!shareCard) {
    debugLog('❌ 错误：找不到分享卡片元素');
    throw new Error('Share card not found');
  }
  
  debugLog('✅ 找到分享卡片元素', {
    width: shareCard.offsetWidth,
    height: shareCard.offsetHeight,
    computedStyle: window.getComputedStyle(shareCard).display
  });

  // 确保字体已加载
  debugLog('📝 开始字体加载流程...');
  await waitForFonts();

  // 等待DOM更新完成
  debugLog('⏳ 等待DOM更新完成...');
  await new Promise(resolve => requestAnimationFrame(resolve));
  await new Promise(resolve => setTimeout(resolve, 300));

  // 检测当前主题
  const isDark = document.documentElement.classList.contains('dark');
  const bgColor = isDark ? '#0a0a0a' : '#ffffff';
  debugLog('🎨 检测主题模式', { isDark, bgColor });

  try {
    debugLog('🖼️ 开始调用 html2canvas...', {
      配置: {
        backgroundColor: bgColor,
        scale: DEBUG_CONFIG.imageScale,
        width: shareCard.offsetWidth,
        height: shareCard.offsetHeight,
        imageTimeout: DEBUG_CONFIG.imageTimeout
      }
    });
    
    // 使用调试配置的 html2canvas 设置
    const canvas = await html2canvas(shareCard, {
      backgroundColor: bgColor,
      scale: DEBUG_CONFIG.imageScale, // 使用调试配置的分辨率缩放
      useCORS: true,
      allowTaint: true,
      foreignObjectRendering: false,
      imageTimeout: DEBUG_CONFIG.imageTimeout, // 使用调试配置的超时时间
      logging: DEBUG_CONFIG.enableDebugLogs, // 启用html2canvas日志
      width: shareCard.offsetWidth,
      height: shareCard.offsetHeight,
      scrollX: 0,
      scrollY: 0,
      windowWidth: shareCard.offsetWidth,
      windowHeight: shareCard.offsetHeight,
      letterRendering: true, // 改善字体渲染
      onclone: function(clonedDoc, element) {
        debugLog('🔄 html2canvas onclone 回调执行中...');
        
        // 在克隆的文档中移除不需要的元素
        const unwantedElements = element.querySelectorAll('.extend-button, .extend-menu');
        debugLog(`🗑️ 移除 ${unwantedElements.length} 个不需要的元素`);
        unwantedElements.forEach(el => el.remove());
        
        // 确保样式正确应用
        element.style.background = bgColor;
        element.style.color = isDark ? '#ffffff' : '#111827';
        debugLog('🎨 应用基础样式完成');
        
        // 彻底重写字体和布局样式处理
        const allElements = element.querySelectorAll('*');
        debugLog(`🔧 开始处理 ${allElements.length} 个元素的样式...`);
        allElements.forEach(el => {
          const computedStyle = window.getComputedStyle(el);
          const fontSize = parseFloat(computedStyle.fontSize);
          
          // 基础字体样式 - 应用调试配置的字体大小
          el.style.fontFamily = computedStyle.fontFamily;
          if (el.classList.contains('share-website')) {
            el.style.fontSize = (DEBUG_CONFIG.websiteFontSize) + 'rem';
          } else if (el.classList.contains('share-date')) {
            el.style.fontSize = (DEBUG_CONFIG.dateFontSize) + 'rem';
          } else {
            el.style.fontSize = computedStyle.fontSize;
          }
          el.style.fontWeight = computedStyle.fontWeight;
          el.style.fontStyle = computedStyle.fontStyle;
          
          // 使用调试配置的行高
          el.style.lineHeight = (fontSize * DEBUG_CONFIG.lineHeight) + 'px';
          
          // 使用调试配置的字符间距
          el.style.letterSpacing = DEBUG_CONFIG.letterSpacing;
          
          // 彻底控制空白处理
          el.style.whiteSpace = 'normal';
          el.style.wordWrap = 'break-word';
          el.style.overflowWrap = 'break-word';
          
          // 使用调试配置设置段落间距
          if (el.tagName === 'P') {
            el.style.margin = `0 0 ${DEBUG_CONFIG.paragraphSpacing}rem 0`;
            el.style.padding = '0';
            el.style.lineHeight = (fontSize * DEBUG_CONFIG.lineHeight) + 'px';
          }
          
          // 移除其他元素的多余间距
          if (['DIV', 'SPAN', 'ARTICLE'].includes(el.tagName)) {
            el.style.lineHeight = (fontSize * DEBUG_CONFIG.lineHeight) + 'px';
          }
          
          // 确保没有多余的空白
          if (el.textContent && el.children.length === 0) {
            el.textContent = el.textContent.replace(/\s+/g, ' ').trim();
          }
        });
        
        debugLog('✅ onclone 回调处理完成');
      }
    });
    
    debugLog('🎉 html2canvas 执行成功！', {
      canvas宽度: canvas.width,
      canvas高度: canvas.height
    });
    
    const dataUrl = canvas.toDataURL('image/png');
    debugLog('📷 图片数据生成完成', {
      数据大小: `${Math.round(dataUrl.length / 1024)}KB`
    });
    
    return dataUrl;
  } catch (error) {
    debugLog('❌ html2canvas 执行失败', error);
    console.error('Error generating image with html2canvas:', error);
    throw error;
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // Add event listeners to all extend buttons
  document.querySelectorAll('.extend-button').forEach(function(button) {
    button.addEventListener('click', function(e) {
      e.stopPropagation();
      
      // Get corresponding menu element
      const menu = this.nextElementSibling;
      
      // Close all other open menus
      document.querySelectorAll('.extend-menu').forEach(function(otherMenu) {
        if (otherMenu !== menu) {
          otherMenu.classList.add('hidden');
          otherMenu.classList.remove('show');
        }
      });
      
      // Toggle current menu display state
      if (menu.classList.contains('hidden')) {
        menu.classList.remove('hidden');
        menu.classList.add('show');
      } else {
        menu.classList.add('hidden');
        menu.classList.remove('show');
      }
    });
  });

  // Add event listeners to menu items
  document.querySelectorAll('.extend-menu-item').forEach(function(item) {
    item.addEventListener('click', function(e) {
      e.stopPropagation();
      
      const action = this.getAttribute('data-action');
      const button = this.closest('.post-meta').querySelector('.extend-button');
      
      if (action === 'copy-markdown') {
        copyAsMarkdown(button);
      } else if (action === 'generate-share-image') {
        generateShareImage(button);
      }
      
      // Close menu
      const menu = this.closest('.extend-menu');
      menu.classList.add('hidden');
      menu.classList.remove('show');
    });
  });

  // Close all menus when clicking elsewhere on page
  document.addEventListener('click', function() {
    document.querySelectorAll('.extend-menu').forEach(function(menu) {
      menu.classList.add('hidden');
      menu.classList.remove('show');
    });
  });

  // Prevent menu clicks from bubbling to document
  document.querySelectorAll('.extend-menu').forEach(function(menu) {
    menu.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  });

  // Copy as Markdown function
  function copyAsMarkdown(button) {
    try {
      const content = button.getAttribute('data-content');
      
      // Build Markdown content - only keep body content
      let markdownContent = '';
      
      // Add content
      if (content && content.trim() !== '') {
        // Decode HTML entities
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = content;
        markdownContent = tempDiv.textContent || tempDiv.innerText || '';
      }
      
      // Use modern Clipboard API
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(markdownContent).then(function() {
          showCopySuccess('Markdown content copied to clipboard');
        }).catch(function(err) {
          console.error('Copy failed:', err);
          fallbackCopy(markdownContent);
        });
      } else {
        // Fallback solution
        fallbackCopy(markdownContent);
      }
    } catch (error) {
      console.error('Error during copy process:', error);
      showCopyError('Copy failed, please try again');
    }
  }

  // Fallback copy solution
  function fallbackCopy(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
      const successful = document.execCommand('copy');
      if (successful) {
        showCopySuccess('Markdown content copied to clipboard');
      } else {
        showCopyError('Copy failed, please copy manually');
      }
    } catch (err) {
      console.error('Fallback copy also failed:', err);
      showCopyError('Copy failed, please copy manually');
    }
    
    document.body.removeChild(textArea);
  }

  // Show copy success notification
  function showCopySuccess(message) {
    showNotification(message, 'success');
  }

  // Show copy error notification
  function showCopyError(message) {
    showNotification(message, 'error');
  }

  // General notification function
  function showNotification(message, type) {
    // Remove existing notification
    const existingNotification = document.querySelector('.copy-notification');
    if (existingNotification) {
      existingNotification.remove();
    }

    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'copy-notification';
    notification.textContent = message;
    
    // Set styles
    const baseStyles = {
      position: 'fixed',
      top: '20px',
      right: '20px',
      padding: '12px 16px',
      borderRadius: '6px',
      fontSize: '14px',
      fontWeight: '500',
      zIndex: '10000',
      maxWidth: '300px',
      wordWrap: 'break-word',
      transition: 'all 0.3s ease'
    };
    
    const typeStyles = type === 'success' 
      ? {
          backgroundColor: '#8b5cf6',
          color: '#ffffff',
          border: '1px solid #7c3aed'
        }
      : {
          backgroundColor: '#ef4444',
          color: '#ffffff',
          border: '1px solid #dc2626'
        };
    
    Object.assign(notification.style, baseStyles, typeStyles);
    
    // Add to page
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(function() {
      if (notification.parentNode) {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(function() {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 300);
      }
    }, 3000);
  }

  // Generate share image function
  function generateShareImage(button) {
    try {
      // Get the rendered HTML content from the current article
      const article = button.closest('.microblog-post');
      const renderedContent = article.querySelector('.prose');
      const title = button.getAttribute('data-title');
      const date = button.getAttribute('data-date');
      
      // Show modal with rendered content
      showShareImageModal(renderedContent, title, date);
    } catch (error) {
      console.error('Error generating share image:', error);
      showCopyError('Failed to generate share image');
    }
  }

  // Show share image modal
  function showShareImageModal(contentElement, title, date) {
    const modal = document.getElementById('share-image-modal');
    const articleContent = modal.querySelector('.share-article-content');
    const shareDate = modal.querySelector('.share-date');
    const shareCard = modal.querySelector('.share-card');
    
    // Store article title globally for filename
    currentArticleTitle = title || '';
    
    // 检测当前主题模式
    const isDark = document.documentElement.classList.contains('dark');
    const bgColor = isDark ? '#0a0a0a' : '#ffffff';
    const textColor = isDark ? '#ffffff' : '#111827';
    const borderColor = isDark ? '#c084fc' : '#a855f7';
    
    // 使用调试配置设置分享卡片样式
    shareCard.style.cssText = `
      width: ${GLOBAL_SHARE_WIDTH}px !important;
      min-width: ${GLOBAL_SHARE_WIDTH}px !important;
      max-width: ${GLOBAL_SHARE_WIDTH}px !important;
      height: auto !important;
      margin: 0 auto !important;
      display: block !important;
      position: relative !important;
      box-sizing: border-box !important;
      overflow: visible !important;
      background: ${bgColor} !important;
      border: ${DEBUG_CONFIG.borderWidth}px dashed ${borderColor} !important;
      border-radius: 8px !important;
      padding: ${DEBUG_CONFIG.cardPadding}rem !important;
      font-family: inherit !important;
      font-size: 1rem !important;
      line-height: ${DEBUG_CONFIG.lineHeight} !important;
      color: ${textColor} !important;
    `;
    
    // 使用调试配置设置内容区域样式
    articleContent.style.cssText = `
      margin-bottom: ${DEBUG_CONFIG.contentBottomMargin}rem !important;
      overflow-wrap: break-word !important;
      word-wrap: break-word !important;
      word-break: break-word !important;
      display: block !important;
      line-height: ${DEBUG_CONFIG.lineHeight} !important;
      letter-spacing: ${DEBUG_CONFIG.letterSpacing} !important;
      white-space: normal !important;
      color: ${textColor} !important;
      padding: 0 !important;
    `;
    
    // Copy the rendered HTML content directly
    if (contentElement && contentElement.innerHTML) {
      // Clone the content to avoid modifying the original
      const clonedContent = contentElement.cloneNode(true);
      
      // Remove any unwanted elements (like scripts, buttons, etc.)
      const unwantedElements = clonedContent.querySelectorAll('script, button, .extend-button, .extend-menu');
      unwantedElements.forEach(element => element.remove());
      
      // 禁用链接
      const links = clonedContent.querySelectorAll('a');
      links.forEach(link => {
        link.removeAttribute('href');
        link.style.pointerEvents = 'none';
      });
      
      // 禁用图片
      const images = clonedContent.querySelectorAll('img');
      images.forEach(img => {
        img.removeAttribute('src');
        img.removeAttribute('srcset');
      });
      
      // Ensure list styles are preserved
      const lists = clonedContent.querySelectorAll('ul, ol');
      lists.forEach(list => {
        if (!list.style.listStyleType) {
          if (list.tagName === 'UL') {
            list.style.listStyleType = 'disc';
          } else if (list.tagName === 'OL') {
            list.style.listStyleType = 'decimal';
          }
        }
      });
      
      // Set the content
      articleContent.innerHTML = clonedContent.innerHTML;
    } else {
      articleContent.innerHTML = '<p>No content available</p>';
    }
    
    // 设置底部区域样式
    const shareCardFooter = shareCard.querySelector('.share-card-footer');
    if (shareCardFooter) {
      const minHeightValue = `calc(${DEBUG_CONFIG.footerPadding * 2}rem + 1.5rem)`;
      shareCardFooter.style.cssText = `
        border-top: ${DEBUG_CONFIG.borderWidth}px dashed ${borderColor} !important;
        padding: ${DEBUG_CONFIG.footerPadding}rem 0 !important;
        margin-top: 0 !important;
        display: flex !important;
        align-items: center !important;
        min-height: ${minHeightValue} !important;
      `;
      debugLog('📐 初始底部区域样式设置', {
        footerPadding: DEBUG_CONFIG.footerPadding + 'rem',
        minHeight: minHeightValue,
        borderWidth: DEBUG_CONFIG.borderWidth + 'px'
      });
    }
    
    const shareFooterInfo = shareCard.querySelector('.share-footer-info');
    if (shareFooterInfo) {
      const footerTextColor = isDark ? '#c084fc' : '#7c3aed';
      shareFooterInfo.style.cssText = `
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        width: 100% !important;
        font-size: 0.875rem !important;
        color: ${footerTextColor} !important;
      `;
    }
    
    // 单独设置网站名称和日期的字体大小和颜色
    const shareWebsite = shareCard.querySelector('.share-website');
    if (shareWebsite) {
      const websiteColor = isDark ? '#a855f7' : '#8b5cf6';
      shareWebsite.style.fontSize = `${DEBUG_CONFIG.websiteFontSize}rem !important`;
      shareWebsite.style.color = `${websiteColor} !important`;
    }
    
    if (shareDate) {
      const dateColor = isDark ? '#c084fc' : '#7c3aed';
      shareDate.style.fontSize = `${DEBUG_CONFIG.dateFontSize}rem !important`;
      shareDate.style.color = `${dateColor} !important`;
    }
    
    // Format and set date
    const formattedDate = formatShareDate(date);
    shareDate.textContent = formattedDate;
    
    // Show modal
    modal.classList.remove('hidden');
    setTimeout(() => {
      modal.classList.add('show');
    }, 10);
  }

  // Format article content with proper styling
  function formatArticleContent(rawContent, title) {
    if (!rawContent || rawContent.trim() === '') {
      return '<p>No content available</p>';
    }
    
    // Decode HTML entities
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = rawContent;
    let content = tempDiv.textContent || tempDiv.innerText || '';
    
    // Convert Markdown-like syntax to HTML
    let html = '';
    
    // Skip title - only include body content
    
    // Process content line by line
    const lines = content.split('\n');
    let inCodeBlock = false;
    let codeBlockContent = '';
    
    for (let i = 0; i < lines.length; i++) {
      let line = lines[i];
      
      // Handle code blocks
      if (line.trim().startsWith('```')) {
        if (inCodeBlock) {
          // End code block
          html += '<pre><code>' + escapeHtml(codeBlockContent.trim()) + '</code></pre>\n';
          codeBlockContent = '';
          inCodeBlock = false;
        } else {
          // Start code block
          inCodeBlock = true;
        }
        continue;
      }
      
      if (inCodeBlock) {
        codeBlockContent += line + '\n';
        continue;
      }
      
      // Handle headings
      if (line.trim().startsWith('### ')) {
        html += '<h3>' + escapeHtml(line.trim().substring(4)) + '</h3>\n';
      } else if (line.trim().startsWith('## ')) {
        html += '<h2>' + escapeHtml(line.trim().substring(3)) + '</h2>\n';
      } else if (line.trim().startsWith('# ')) {
        html += '<h1>' + escapeHtml(line.trim().substring(2)) + '</h1>\n';
      }
      // Handle list items
      else if (line.trim().startsWith('- ') || line.trim().startsWith('* ')) {
        html += '<li>' + escapeHtml(line.trim().substring(2)) + '</li>\n';
      }
      // Handle numbered lists
      else if (/^\d+\.\s/.test(line.trim())) {
        html += '<li>' + escapeHtml(line.trim().replace(/^\d+\.\s/, '')) + '</li>\n';
      }
      // Handle inline code
      else if (line.trim() !== '') {
        let processedLine = escapeHtml(line.trim());
        // Convert `code` to <code>code</code>
        processedLine = processedLine.replace(/`([^`]+)`/g, '<code>$1</code>');
        html += '<p>' + processedLine + '</p>\n';
      }
      // Handle empty lines
      else {
        html += '\n';
      }
    }
    
    return html;
  }

  // Format date for share image
  function formatShareDate(dateString) {
    if (!dateString) return '';
    
    try {
      const date = new Date(dateString);
      const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const weekday = weekdays[date.getDay()];
      
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      
      return `${year}/${month}/${day} (${weekday})`;
    } catch (error) {
      return dateString;
    }
  }

  // Escape HTML entities
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Generate filename from article title
  function getArticleFilename() {
    if (!currentArticleTitle || currentArticleTitle.trim() === '') {
      return 'share-image.png';
    }
    
    // Clean the title for use as filename
    let filename = currentArticleTitle
      .trim()
      .replace(/[^\w\s\-\u4e00-\u9fff]/g, '') // Keep only alphanumeric, spaces, hyphens, and Chinese characters
      .replace(/\s+/g, '-') // Replace spaces with hyphens
      .replace(/-+/g, '-') // Replace multiple hyphens with single hyphen
      .replace(/^-+|-+$/g, ''); // Remove leading/trailing hyphens
    
    // Limit filename length
    if (filename.length > 50) {
      filename = filename.substring(0, 50);
    }
    
    // Add .png extension
    return filename + '.png';
  }

  // Close share image modal
  function closeShareImageModal() {
    const modal = document.getElementById('share-image-modal');
    modal.classList.remove('show');
    setTimeout(() => {
      modal.classList.add('hidden');
    }, 300);
  }

  // Download share image
  function downloadShareImage() {
    debugLog('📥 开始下载分享图片流程...');
    
    // Show loading state
    const downloadBtn = document.querySelector('.share-download-btn');
    const originalText = downloadBtn.textContent;
    downloadBtn.textContent = 'Generating...';
    downloadBtn.disabled = true;
    debugLog('🔄 按钮状态已设为生成中...');
    
    renderShareImageImproved().then(function(dataUrl) {
      debugLog('✅ 图片生成成功，开始下载...');
      // Get article title for filename
      const filename = getArticleFilename();
      
      // Create download link
      const link = document.createElement('a');
      link.download = filename;
      link.href = dataUrl;
      
      // Trigger download
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Reset button
      downloadBtn.textContent = originalText;
      downloadBtn.disabled = false;
      debugLog('🔄 按钮状态已重置');
      
      showCopySuccess('Share image downloaded successfully');
      debugLog('📥 下载流程完成 ✅');
    }).catch(function(error) {
      debugLog('❌ 下载失败', error);
      console.error('Error generating image:', error);
      downloadBtn.textContent = originalText;
      downloadBtn.disabled = false;
      showCopyError('Failed to generate image');
    });
  }

  // Copy share image to clipboard
  function copyShareImage() {
    debugLog('📋 开始复制分享图片流程...');
    
    // Show loading state
    const copyBtn = document.querySelector('.share-copy-btn');
    const originalText = copyBtn.textContent;
    copyBtn.textContent = 'Copying...';
    copyBtn.disabled = true;
    debugLog('🔄 复制按钮状态已设为复制中...');
    
    renderShareImageImproved().then(function(dataUrl) {
      debugLog('✅ 图片生成成功，开始复制到剪贴板...');
      // Convert data URL to blob
      fetch(dataUrl)
        .then(res => res.blob())
        .then(blob => {
        if (navigator.clipboard && window.ClipboardItem) {
          // Use modern Clipboard API
          const item = new ClipboardItem({ 'image/png': blob });
          navigator.clipboard.write([item]).then(function() {
            // Reset button
            copyBtn.textContent = originalText;
            copyBtn.disabled = false;
            showCopySuccess('Share image copied to clipboard');
          }).catch(function(error) {
            console.error('Failed to copy image:', error);
            copyBtn.textContent = originalText;
            copyBtn.disabled = false;
            showCopyError('Failed to copy image to clipboard');
          });
        } else {
          // Fallback: show a message that copying is not supported
          copyBtn.textContent = originalText;
          copyBtn.disabled = false;
          showCopyError('Image copy not supported in this browser');
        }
        })
        .catch(function(error) {
          console.error('Failed to convert image:', error);
          copyBtn.textContent = originalText;
          copyBtn.disabled = false;
          showCopyError('Failed to copy image');
        });
    }).catch(function(error) {
      console.error('Error generating image for copy:', error);
      copyBtn.textContent = originalText;
      copyBtn.disabled = false;
      showCopyError('Failed to copy image');
    });
  }

  // Add modal event listeners
  document.addEventListener('click', function(e) {
    // Close modal when clicking outside
    if (e.target.classList.contains('share-modal')) {
      closeShareImageModal();
    }
    
    // Close modal when clicking close button
    if (e.target.classList.contains('share-modal-close')) {
      closeShareImageModal();
    }
    
    // Download image when clicking download button
    if (e.target.classList.contains('share-download-btn')) {
      downloadShareImage();
    }
    
    // Copy image when clicking copy button
    if (e.target.classList.contains('share-copy-btn')) {
      copyShareImage();
    }
  });

  // Close modal with Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const modal = document.getElementById('share-image-modal');
      if (modal && !modal.classList.contains('hidden')) {
        closeShareImageModal();
      }
    }
  });
});
</script> 